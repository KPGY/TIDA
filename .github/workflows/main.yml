name: Automatic Nextron Release

# master ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    
    # â—ï¸ ë¦´ë¦¬ì¦ˆ ìƒì„± ë° íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•´ ê¶Œí•œ ì„¤ì • (í•„ìˆ˜)
    permissions:
      contents: write 
      
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          # npm version ëª…ë ¹ì„ ìœ„í•´ ì „ì²´ ì»¤ë°‹ ê¸°ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
          fetch-depth: 0 
        
      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 

      - name: ğŸ“¥ Install dependencies
        run: npm install
        
      # 1. Git User ì„¤ì •
      - name: âš™ï¸ Configure Git User
        run: |
          # Git ì‘ì—…(ì»¤ë°‹ ë° íƒœê·¸)ì„ ìœ„í•œ ì‚¬ìš©ì ì •ë³´ ì„¤ì •
          git config user.name "GitHub Actions Bot"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
      # 2. Commit Lockfile Changes: npm installë¡œ ì¸í•œ ë³€ê²½ì‚¬í•­ ì»¤ë°‹
      - name: ğŸ’¾ Commit Lockfile Changes
        run: |
          if git diff --quiet; then
            echo "No lockfile changes detected. Proceeding."
          else
            echo "Lockfile changes detected. Committing them now."
            git add .
            git commit -m "chore: lockfile update from npm install (auto)"
          fi
          
      # 3. Increment Version and Tag: npm version ëª…ë ¹ ì‹¤í–‰
      - name: â¬†ï¸ Increment Version and Tag
        run: npm version patch 
               
      # 4. Push Commits and Tags: ëª¨ë“  ë³€ê²½ì‚¬í•­ê³¼ íƒœê·¸ í‘¸ì‹œ
      - name: ğŸš€ Push Commits and Tags
        run: git push && git push --tags
              
      # 5. Build and Publish: Docker ê¸°ë°˜ electron-builder ì•¡ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ ë° ë°œí–‰
      - name: ğŸ“¦ Build and Publish Nextron App (Using Docker)
        uses: samuelmeuli/action-electron-builder@v1
        with:
          # package.jsonì˜ "release" ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. (nextron build -- --publish always)
          build_script_name: release 
          # GitHub í† í°ì„ ì „ë‹¬í•˜ì—¬ ë¦´ë¦¬ì¦ˆ ìƒì„± ë° íŒŒì¼ ì—…ë¡œë“œ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
          github_token: ${{ secrets.GITHUB_TOKEN }}
