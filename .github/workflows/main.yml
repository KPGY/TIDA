name: Automatic Nextron Release

# master ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    
    # â—ï¸ ë¦´ë¦¬ì¦ˆ ìƒì„± ë° íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•´ ê¶Œí•œ ì„¤ì • (í•„ìˆ˜)
    permissions:
      contents: write 
      
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          # npm version ëª…ë ¹ì„ ìœ„í•´ ì „ì²´ ì»¤ë°‹ ê¸°ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
          fetch-depth: 0 
        
      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 

      - name: ğŸ“¥ Install dependencies
        run: npm install
        
      # ğŸš¨ 1. Git User ì„¤ì •: ëª¨ë“  ì»¤ë°‹ ì „ì— ë°˜ë“œì‹œ ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
      - name: âš™ï¸ Configure Git User
        run: |
          # Git ì‘ì—…(ë²„ì „ ì»¤ë°‹ ë° íƒœê·¸)ì„ ìœ„í•œ ì‚¬ìš©ì ì •ë³´ ì„¤ì •
          git config user.name "GitHub Actions Bot"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
      # 2. ğŸ’¾ Commit Lockfile Changes: npm installë¡œ ì¸í•œ ë³€ê²½ì‚¬í•­ ì»¤ë°‹
      - name: ğŸ’¾ Commit Lockfile Changes
        run: |
          if git diff --quiet; then
            echo "No lockfile changes detected. Proceeding."
          else
            echo "Lockfile changes detected. Committing them now."
            # Git Userê°€ ì„¤ì •ë˜ì–´ ìˆì–´ ì»¤ë°‹ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            git add .
            git commit -m "chore: lockfile update from npm install (auto)"
          fi
          
      # 3. â¬†ï¸ Increment Version and Tag: npm version ëª…ë ¹ ì‹¤í–‰ (ë‚´ë¶€ì ìœ¼ë¡œ ì»¤ë°‹ì„ ìˆ˜í–‰)
      - name: â¬†ï¸ Increment Version and Tag
        run: npm version patch 
               
      # 4. ğŸš€ Push Commits and Tags: ëª¨ë“  ë³€ê²½ì‚¬í•­(lockfile ì»¤ë°‹, version ì»¤ë°‹)ê³¼ íƒœê·¸ í‘¸ì‹œ
      - name: ğŸš€ Push Commits and Tags
        run: git push && git push --tags

      # ğŸš¨ 5. ë¹Œë“œ í™˜ê²½ ì¤€ë¹„: app-builder ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° Linux ì¢…ì†ì„± ì„¤ì¹˜ (ERR_ELECTRON_BUILDER_CANNOT_EXECUTE í•´ê²°)
      - name: âš™ï¸ Prepare Electron Builder Environment
        run: |
          # app-builder ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x ./node_modules/app-builder-bin/linux/x64/app-builder
          
          # í•„ìˆ˜ ì‹œìŠ¤í…œ ì¢…ì†ì„± ì„¤ì¹˜ (Linux ë¹Œë“œ ì•ˆì •ì„± í™•ë³´)
          sudo apt-get update
          sudo apt-get install --no-install-recommends -y icnsutils graphicsmagick xz-utils
              
      # 6. ğŸ“¦ Build and Publish Nextron App: ë¦´ë¦¬ì¦ˆ ë°œí–‰
      - name: ğŸ“¦ Build and Publish Nextron App
        run: npm run release
        env:
          # electron-builderê°€ ë¦´ë¦¬ì¦ˆë¥¼ ìƒì„±í•˜ê³  íŒŒì¼ì„ ì—…ë¡œë“œí•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
